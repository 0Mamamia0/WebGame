<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>数独游戏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #sudoku-board {
            border: 3px solid #333;
            display: grid;
            grid-template-columns: repeat(9, 50px);
            grid-template-rows: repeat(9, 50px);
            gap: 1px;
            background-color: #333;
        }

        .cell {
            width: 50px;
            height: 50px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        /* 添加3x3宫格粗边框 */
        .cell:nth-child(3n) {
            border-right: 2px solid #333;
        }

        .cell:nth-child(9n) {
            border-right: none;
        }

        /* 每三行底部加粗边框 */
        .row-2 .cell, .row-5 .cell {
            border-bottom: 2px solid #333;
        }

        .cell.fixed {
            background-color: #f0f0f0;
            color: #000;
        }

        .cell.selected {
            background-color: #d4e6f1;
        }

        .cell.highlighted {
            background-color: #e6f7ff;
        }

        .cell.same-number {
            background-color: #b8d8eb;
        }

        .cell.error {
            color: red;
        }

        #controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #number-selector {
            display: flex;
            gap: 5px;
            margin-top: 20px;
        }

        .number-btn {
            width: 40px;
            height: 40px;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .number-btn:hover {
            background-color: #ccc;
        }

        #timer {
            font-size: 24px;
            margin-top: 20px;
            color: #333;
        }

        #difficulty {
            margin-top: 10px;
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<h1>数独游戏</h1>

<label for="difficulty"></label><select id="difficulty">
    <option value="easy">简单</option>
    <option value="medium">中等</option>
    <option value="hard">困难</option>
</select>

<div id="sudoku-board"></div>

<div id="timer">时间: 00:00</div>

<div id="number-selector">
    <button class="number-btn" data-number="1">1</button>
    <button class="number-btn" data-number="2">2</button>
    <button class="number-btn" data-number="3">3</button>
    <button class="number-btn" data-number="4">4</button>
    <button class="number-btn" data-number="5">5</button>
    <button class="number-btn" data-number="6">6</button>
    <button class="number-btn" data-number="7">7</button>
    <button class="number-btn" data-number="8">8</button>
    <button class="number-btn" data-number="9">9</button>
    <button class="number-btn" data-number="0">清除</button>
</div>

<div id="controls">
    <button id="new-game">新游戏</button>
    <button id="check-solution">检查答案</button>
    <button id="solve">显示答案</button>
</div>

<script>
    // 游戏变量
    let board = Array(9).fill().map(() => Array(9).fill(0));
    let solution = Array(9).fill().map(() => Array(9).fill(0));
    let fixedCells = Array(9).fill().map(() => Array(9).fill(false));
    let selectedCell = null;
    let selectedNumber = null;
    let startTime = null;
    let timerInterval = null;

    // DOM元素
    const sudokuBoard = document.getElementById('sudoku-board');
    const timerElement = document.getElementById('timer');
    const newGameBtn = document.getElementById('new-game');
    const checkSolutionBtn = document.getElementById('check-solution');
    const solveBtn = document.getElementById('solve');
    const numberBtns = document.querySelectorAll('.number-btn');
    const difficultySelect = document.getElementById('difficulty');

    // 初始化游戏
    function init() {
        createBoard();
        newGame();

        // 事件监听
        newGameBtn.addEventListener('click', newGame);
        checkSolutionBtn.addEventListener('click', checkSolution);
        solveBtn.addEventListener('click', showSolution);

        numberBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const number = parseInt(btn.dataset.number);
                selectedNumber = isNaN(number) ? null : number;

                if (selectedCell) {
                    const row = selectedCell.dataset.row;
                    const col = selectedCell.dataset.col;

                    if (!fixedCells[row][col]) {
                        board[row][col] = selectedNumber || 0;
                        updateBoard();
                        checkWin();
                    }
                }

                // 高亮相同数字
                highlightSameNumbers(selectedNumber);
            });
        });

        // 键盘输入支持
        document.addEventListener('keydown', (e) => {
            if (!selectedCell) return;

            const row = parseInt(selectedCell.dataset.row);
            const col = parseInt(selectedCell.dataset.col);

            if (fixedCells[row][col]) return;

            if (e.key >= '1' && e.key <= '9') {
                selectedNumber = parseInt(e.key);
                board[row][col] = selectedNumber;
                updateBoard();
                checkWin();
                highlightSameNumbers(selectedNumber);
            } else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
                selectedNumber = null;
                board[row][col] = 0;
                updateBoard();
                highlightSameNumbers(null);
            } else if (e.key === 'ArrowUp' && row > 0) {
                selectCell(row - 1, col);
            } else if (e.key === 'ArrowDown' && row < 8) {
                selectCell(row + 1, col);
            } else if (e.key === 'ArrowLeft' && col > 0) {
                selectCell(row, col - 1);
            } else if (e.key === 'ArrowRight' && col < 8) {
                selectCell(row, col + 1);
            }
        });
    }

    // 创建数独棋盘
    function createBoard() {
        sudokuBoard.innerHTML = '';

        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = row;
                cell.dataset.col = col;

                // 添加行类名用于3x3宫格边框
                if (row === 2 || row === 5) {
                    cell.classList.add(`row-${row}`);
                }

                cell.addEventListener('click', () => {
                    selectCell(row, col);
                    if (selectedCell.textContent && !selectedCell.classList.contains('fixed')) {
                        highlightSameNumbers(parseInt(selectedCell.textContent));
                    }
                });

                sudokuBoard.appendChild(cell);
            }
        }
    }

    // 高亮所有相同数字的单元格
    function highlightSameNumbers(number) {
        // 清除之前的高亮
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.remove('same-number');
        });

        if (number !== null && number !== 0) {
            // 高亮所有相同数字的单元格
            document.querySelectorAll('.cell').forEach(cell => {
                if (cell.textContent === number.toString()) {
                    cell.classList.add('same-number');
                }
            });
        }
    }

    // 选择单元格
    function selectCell(row, col) {
        // 清除之前选中的单元格样式
        if (selectedCell) {
            selectedCell.classList.remove('selected');
            highlightRelatedCells(selectedCell.dataset.row, selectedCell.dataset.col, false);
        }

        // 设置新选中的单元格
        selectedCell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        selectedCell.classList.add('selected');
        highlightRelatedCells(row, col, true);
    }

    // 高亮相关单元格(同一行、列和3x3宫)
    function highlightRelatedCells(row, col, highlight) {
        // 清除所有高亮
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.remove('highlighted');
        });

        if (highlight) {
            // 高亮同一行
            for (let c = 0; c < 9; c++) {
                const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${c}"]`);
                if (c != col) cell.classList.add('highlighted');
            }

            // 高亮同一列
            for (let r = 0; r < 9; r++) {
                const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${col}"]`);
                if (r != row) cell.classList.add('highlighted');
            }

            // 高亮同一3x3宫
            const boxRow = Math.floor(row / 3) * 3;
            const boxCol = Math.floor(col / 3) * 3;

            for (let r = boxRow; r < boxRow + 3; r++) {
                for (let c = boxCol; c < boxCol + 3; c++) {
                    if (r != row || c != col) {
                        const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
                        cell.classList.add('highlighted');
                    }
                }
            }
        }
    }

    // 更新棋盘显示
    function updateBoard() {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                cell.textContent = board[row][col] === 0 ? '' : board[row][col];
                cell.className = 'cell';

                // 添加行类名用于3x3宫格边框
                if (row === 2 || row === 5) {
                    cell.classList.add(`row-${row}`);
                }

                if (fixedCells[row][col]) {
                    cell.classList.add('fixed');
                }

                // 标记冲突的数字
                if (board[row][col] !== 0 && !isValidPlacement(row, col, board[row][col])) {
                    cell.classList.add('error');
                }
            }
        }

        // 重新应用选中单元格的样式
        if (selectedCell) {
            selectedCell.classList.add('selected');
            highlightRelatedCells(selectedCell.dataset.row, selectedCell.dataset.col, true);
        }

        // 重新应用相同数字高亮
        if (selectedNumber !== null) {
            highlightSameNumbers(selectedNumber);
        }
    }

    // 检查数字放置是否有效
    function isValidPlacement(row, col, num) {
        // 检查行
        for (let c = 0; c < 9; c++) {
            if (c !== col && board[row][c] === num) return false;
        }

        // 检查列
        for (let r = 0; r < 9; r++) {
            if (r !== row && board[r][col] === num) return false;
        }

        // 检查3x3宫
        const boxRow = Math.floor(row / 3) * 3;
        const boxCol = Math.floor(col / 3) * 3;

        for (let r = boxRow; r < boxRow + 3; r++) {
            for (let c = boxCol; c < boxCol + 3; c++) {
                if (r !== row && c !== col && board[r][c] === num) return false;
            }
        }

        return true;
    }

    // 生成新的数独游戏
    function newGame() {
        // 重置计时器
        stopTimer();
        startTime = new Date();
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();

        // 重置选择状态
        selectedCell = null;
        selectedNumber = null;

        // 生成完整解决方案
        generateSolution();

        // 根据难度移除数字
        const difficulty = difficultySelect.value;
        let cellsToRemove;

        switch(difficulty) {
            case 'easy':
                cellsToRemove = 40; // 保留41个数字
                break;
            case 'medium':
                cellsToRemove = 50; // 保留31个数字
                break;
            case 'hard':
                cellsToRemove = 60; // 保留21个数字
                break;
            default:
                cellsToRemove = 40;
        }

        // 复制解决方案到游戏板
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                board[row][col] = solution[row][col];
                fixedCells[row][col] = false;
            }
        }

        // 随机移除数字
        let removed = 0;
        while (removed < cellsToRemove) {
            const row = Math.floor(Math.random() * 9);
            const col = Math.floor(Math.random() * 9);

            if (board[row][col] !== 0) {
                board[row][col] = 0;
                removed++;
            }
        }

        // 标记固定单元格
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                fixedCells[row][col] = board[row][col] !== 0;
            }
        }

        // 更新棋盘
        updateBoard();
    }

    // 生成有效的数独解决方案
    function generateSolution() {
        // 重置解决方案
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                solution[row][col] = 0;
            }
        }

        // 使用回溯算法填充解决方案
        solveSudoku(solution);
    }

    // 回溯算法解决数独
    function solveSudoku(grid) {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (grid[row][col] === 0) {
                    // 随机尝试数字1-9
                    const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                    shuffleArray(numbers);

                    for (const num of numbers) {
                        if (isValidPlacementInGrid(grid, row, col, num)) {
                            grid[row][col] = num;

                            if (solveSudoku(grid)) {
                                return true;
                            }

                            grid[row][col] = 0;
                        }
                    }
                    return false;
                }
            }
        }
        return true;
    }

    // 检查数字在给定网格中的放置是否有效
    function isValidPlacementInGrid(grid, row, col, num) {
        // 检查行
        for (let c = 0; c < 9; c++) {
            if (grid[row][c] === num) return false;
        }

        // 检查列
        for (let r = 0; r < 9; r++) {
            if (grid[r][col] === num) return false;
        }

        // 检查3x3宫
        const boxRow = Math.floor(row / 3) * 3;
        const boxCol = Math.floor(col / 3) * 3;

        for (let r = boxRow; r < boxRow + 3; r++) {
            for (let c = boxCol; c < boxCol + 3; c++) {
                if (grid[r][c] === num) return false;
            }
        }

        return true;
    }

    // 随机打乱数组
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // 检查当前棋盘是否完成
    function checkWin() {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (board[row][col] === 0 || !isValidPlacement(row, col, board[row][col])) {
                    return false;
                }
            }
        }

        // 所有单元格都填满且有效
        setTimeout(() => {
            stopTimer();
            alert(`恭喜你完成了数独!\n用时: ${timerElement.textContent}`);
        }, 100);

        return true;
    }

    // 检查当前解答是否正确
    function checkSolution() {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (board[row][col] !== solution[row][col]) {
                    alert('解答有错误，请继续努力!');
                    return false;
                }
            }
        }

        alert('恭喜! 你的解答完全正确!');
        stopTimer();
        return true;
    }

    // 显示完整解答
    function showSolution() {
        if (confirm('确定要查看答案吗? 这将结束当前游戏。')) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    board[row][col] = solution[row][col];
                    fixedCells[row][col] = true;
                }
            }

            updateBoard();
            stopTimer();
        }
    }

    // 更新计时器
    function updateTimer() {
        if (!startTime) return;

        const currentTime = new Date();
        const elapsed = Math.floor((currentTime - startTime) / 1000);

        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');

        timerElement.textContent = `时间: ${minutes}:${seconds}`;
    }

    // 停止计时器
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    // 初始化游戏
    init();
</script>
</body>
</html>